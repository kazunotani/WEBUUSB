<!DOCTYPE html>
<html>
<head>
  <title>WebUSB Echo</title>
</head>
<body>
  <h2>🔌 WebUSB Echo 通信テスト</h2>
  <button id="connect">Arduinoに接続</button><br><br>

  <input id="input" type="text" placeholder="メッセージ入力">
  <button id="send">送信</button>
  <pre id="log"></pre>

  <script>
    let device;

    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\n";
    };

  document.getElementById("connect").onclick = async () => {
  try {
    device = await navigator.usb.requestDevice({
      filters: [{ vendorId: 0x2341 }]
    });
    await device.open();

    console.log("👉 デバイス情報:");
    console.log(device.configurations);

    await device.selectConfiguration(1);
    await device.claimInterface(2);  // 仮で 2 にしてみる（1が失敗する場合あり）

    console.log("✅ デバイスに接続しました");
  } catch (e) {
    console.log("❌ 接続失敗:", e);
  }
};

    document.getElementById("send").onclick = async () => {
      const text = document.getElementById("input").value + "\n";
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      try {
        await device.transferOut(3, data); // endpoint番号は3か4が多い
        log("送信: " + text.trim());
      } catch (e) {
        log("送信失敗: " + e);
      }
    };
  </script>
</body>
</html>
