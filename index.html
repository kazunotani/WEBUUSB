<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebSerial LED Control</title>
</head>
<body>
  <h1>WebSerial LED Control</h1>
  <button id="connect">Connect</button>
  <button id="ledOn" disabled>LED ON</button>
  <button id="ledOff" disabled>LED OFF</button>
  <pre id="log"></pre>

  <script>
    let port;
    let writer, reader;

    const log = (msg) => {
      document.getElementById("log").textContent += msg + "\n";
    };

    document.getElementById("connect").onclick = async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        const textEncoder = new TextEncoderStream();
        const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
        writer = textEncoder.writable.getWriter();

        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        reader = textDecoder.readable.getReader();

        log("✅ Connected to device!");

        readLoop(); // 開始

        document.getElementById("ledOn").disabled = false;
        document.getElementById("ledOff").disabled = false;
      } catch (e) {
        log("❌ Connection failed: " + e);
      }
    };

    const send = async (msg) => {
      await writer.write(msg + "\n");
    };

    document.getElementById("ledOn").onclick = () => send("ON");
    document.getElementById("ledOff").onclick = () => send("OFF");

    async function readLoop() {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        log("🟢 " + value);
      }
    }
  </script>
</body>
</html>
