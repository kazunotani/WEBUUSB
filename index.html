<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebUSB Echo Test</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    textarea { width: 100%; height: 200px; }
    input[type="text"] { width: 70%; padding: 0.5em; }
    button { padding: 0.5em 1em; margin-left: 0.5em; }
  </style>
</head>
<body>
  <h1>ğŸ”Œ WebUSB Echo é€šä¿¡ãƒ†fã‚¹ãƒˆ</h1>
  <button id="connect">ãƒ‡ãƒã‚¤ã‚¹æ¥ç¶š</button>
  <br><br>
  <input type="text" id="input" placeholder="Arduino ã«é€ä¿¡ã™ã‚‹æ–‡å­—åˆ—">
  <button id="send">é€ä¿¡</button>
  <br><br>
  <textarea id="log" readonly></textarea>

  <script>
    let device;

    function log(msg) {
      const logArea = document.getElementById("log");
      logArea.value += msg + "\n";
      logArea.scrollTop = logArea.scrollHeight;
    }

    document.getElementById("connect").onclick = async () => {
      try {
        device = await navigator.usb.requestDevice({
          filters: [{ vendorId: 0x2341 }]  // Arduino ã®ãƒ™ãƒ³ãƒ€ãƒ¼ID
        });

        await device.open();
        await device.selectConfiguration(1);
        await device.claimInterface(2);  // interfaceNumber 2ï¼ˆãƒ­ã‚°ã§ç¢ºèªæ¸ˆã¿ï¼‰

        log("âœ… ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶šã—ã¾ã—ãŸ");

        // æ¥ç¶šæ™‚ã®æ§‹æˆè¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        for (const iface of device.configuration.interfaces) {
          log("Interface Number: " + iface.interfaceNumber);
          for (const alt of iface.alternates) {
            log("  Class: " + alt.interfaceClass);
            for (const ep of alt.endpoints) {
              log(`    Endpoint: ${ep.endpointNumber}, Direction: ${ep.direction}`);
            }
          }
        }

      } catch (e) {
        log("âŒ æ¥ç¶šå¤±æ•—: " + e);
      }
    };

    document.getElementById("send").onclick = async () => {
      if (!device) {
        log("âš ï¸ å…ˆã«ãƒ‡ãƒã‚¤ã‚¹ã¸æ¥ç¶šã—ã¦ãã ã•ã„");
        return;
      }

      const text = document.getElementById("input").value + "\n";
      const encoder = new TextEncoder();
      const data = encoder.encode(text);

      try {
        await device.transferOut(4, data);  // endpoint 4: PC â†’ Arduino
        log("é€ä¿¡: " + text.trim());

        const result = await device.transferIn(5, 64);  // endpoint 5: Arduino â†’ PC
        const decoder = new TextDecoder();
        const receivedText = decoder.decode(result.data);
        log("å—ä¿¡: " + receivedText.trim());
      } catch (e) {
        log("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
      }
    };
  </script>
</body>
</html>
